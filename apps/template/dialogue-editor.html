<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a25;
            --bg-input: #0f0f14;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9590;
            --text-muted: #5a5550;
            --accent-gold: #c9a227;
            --accent-copper: #b87333;
            --accent-teal: #2d8a8a;
            --danger: #8b3a3a;
            --danger-hover: #a84848;
            --success: #3a6b3a;
            --border: rgba(201, 162, 39, 0.15);
            --border-focus: rgba(201, 162, 39, 0.4);
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-gold);
            letter-spacing: 0.05em;
        }

        .project-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 250px;
        }

        .project-title:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--accent-gold);
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--bg-deep);
            border-color: var(--accent-gold);
        }

        .btn-primary:hover {
            background: var(--accent-copper);
            border-color: var(--accent-copper);
        }

        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: var(--text-primary);
        }

        /* Sidebar - Node List */
        .sidebar {
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .node-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .node-item {
            padding: 0.75rem;
            margin-bottom: 0.25rem;
            background: var(--bg-elevated);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .node-item:hover {
            border-color: var(--border);
        }

        .node-item.active {
            border-left-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.08);
        }

        .node-item.start-node {
            border-left-color: var(--accent-teal);
        }

        .node-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-bottom: 0.25rem;
        }

        .node-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .node-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.35rem;
        }

        .node-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            background: var(--bg-surface);
            color: var(--text-muted);
            border-radius: 2px;
        }

        .node-tag.start {
            background: rgba(45, 138, 138, 0.2);
            color: var(--accent-teal);
        }

        /* Main Editor */
        .editor-main {
            background: var(--bg-deep);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .editor-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            padding: 1.25rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .form-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .form-input,
        .form-select,
        .form-textarea {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.7;
        }

        .form-select {
            cursor: pointer;
        }

        /* Choices Editor */
        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .choice-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 1rem;
            position: relative;
        }

        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .choice-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-gold);
        }

        .choice-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            line-height: 1;
        }

        .effects-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }

        .effect-group {
            background: var(--bg-surface);
            padding: 0.6rem;
        }

        .effect-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .effect-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            align-items: center;
        }

        .effect-row input {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.3rem 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .effect-row input:first-child {
            flex: 1;
        }

        .effect-row input:last-child {
            width: 60px;
            text-align: center;
        }

        .effect-row input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .btn-add-effect {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
        }

        /* Right Panel - Settings & Preview */
        .right-panel {
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .panel-section:last-child {
            flex: 1;
            overflow-y: auto;
        }

        .approval-type-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .approval-type-item input {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .approval-type-item input:first-child {
            width: 80px;
        }

        .approval-type-item input:nth-child(2) {
            flex: 1;
        }

        .approval-type-item input:last-of-type {
            width: 50px;
            text-align: center;
        }

        .approval-type-item input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* JSON Preview */
        .json-preview {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: var(--bg-input);
            color: var(--text-secondary);
            padding: 1rem;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            height: 100%;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 1.5rem;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.15rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .modal textarea {
            width: 100%;
            height: 400px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 1rem;
            resize: vertical;
        }

        .modal textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 1px solid var(--accent-gold);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .app {
                grid-template-columns: 240px 1fr;
            }
            .right-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-left">
                <span class="logo">Dialogue Editor</span>
                <input type="text" class="project-title" id="projectTitle" placeholder="Untitled Project" value="New Dialogue">
            </div>
            <div class="header-actions">
                <button class="btn" onclick="newProject()">New</button>
                <button class="btn" onclick="openImportModal()">Import</button>
                <button class="btn btn-primary" onclick="exportJSON()">Export JSON</button>
                <button class="btn" onclick="copyToClipboard()">Copy</button>
            </div>
        </header>

        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Dialogue Nodes</span>
                <button class="btn" onclick="addNode()">+ Add</button>
            </div>
            <div class="node-list" id="nodeList"></div>
        </aside>

        <main class="editor-main" id="editorMain">
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">◇</div>
                <p>Select a node to edit or create a new one</p>
            </div>

            <div id="nodeEditor" style="display: none;">
                <div class="editor-section">
                    <div class="section-header">
                        <span class="section-title">Node Settings</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="setAsStart()">Set as Start</button>
                            <button class="btn btn-danger" onclick="deleteCurrentNode()">Delete</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Node ID</label>
                            <input type="text" class="form-input" id="nodeId" placeholder="unique_id">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Speaker</label>
                            <input type="text" class="form-input" id="nodeSpeaker" placeholder="Character name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dialogue Text</label>
                        <textarea class="form-textarea" id="nodeText" placeholder="What the character says..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Node (if no choices)</label>
                        <select class="form-select" id="nodeNext">
                            <option value="">— End / Has Choices —</option>
                        </select>
                    </div>
                </div>

                <div class="editor-section">
                    <div class="section-header">
                        <span class="section-title">Choices</span>
                        <button class="btn" onclick="addChoice()">+ Add Choice</button>
                    </div>
                    <div class="choices-list" id="choicesList"></div>
                </div>
            </div>
        </main>

        <aside class="right-panel">
            <div class="panel-section">
                <div class="section-header" style="margin-bottom: 0.75rem; padding-bottom: 0.5rem;">
                    <span class="section-title">Approval Types</span>
                    <button class="btn" onclick="addApprovalType()">+ Add</button>
                </div>
                <div id="approvalTypesList"></div>
            </div>

            <div class="panel-section">
                <div class="section-header" style="margin-bottom: 0.75rem; padding-bottom: 0.5rem;">
                    <span class="section-title">JSON Preview</span>
                </div>
                <div class="json-preview" id="jsonPreview">{}</div>
            </div>
        </aside>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h2 class="modal-title">Import Dialogue JSON</h2>
            <textarea id="importTextarea" placeholder="Paste your dialogue JSON here..."></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="importJSON()">Import</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let project = {
            title: 'New Dialogue',
            startNode: '',
            approvalTypes: [
                { id: 'political', name: 'Political Approval', initial: 50 },
                { id: 'community', name: 'Community Approval', initial: 50 }
            ],
            nodes: []
        };

        let currentNodeIndex = -1;

        // Initialize
        function init() {
            renderNodeList();
            renderApprovalTypes();
            updateJSONPreview();
            setupAutoSave();
        }

        function setupAutoSave() {
            // Auto-save current node on input change
            document.getElementById('nodeId').addEventListener('input', saveCurrentNode);
            document.getElementById('nodeSpeaker').addEventListener('input', saveCurrentNode);
            document.getElementById('nodeText').addEventListener('input', saveCurrentNode);
            document.getElementById('nodeNext').addEventListener('change', saveCurrentNode);
            document.getElementById('projectTitle').addEventListener('input', () => {
                project.title = document.getElementById('projectTitle').value;
                updateJSONPreview();
            });
        }

        // Node List
        function renderNodeList() {
            const list = document.getElementById('nodeList');
            list.innerHTML = project.nodes.map((node, index) => `
                <div class="node-item ${index === currentNodeIndex ? 'active' : ''} ${node.id === project.startNode ? 'start-node' : ''}" 
                     onclick="selectNode(${index})">
                    <div class="node-id">${node.id || 'unnamed'}</div>
                    <div class="node-preview">${node.text || 'No text'}</div>
                    <div class="node-meta">
                        ${node.id === project.startNode ? '<span class="node-tag start">START</span>' : ''}
                        ${node.choices && node.choices.length > 0 ? `<span class="node-tag">${node.choices.length} choices</span>` : ''}
                        ${node.next ? '<span class="node-tag">→ ' + node.next + '</span>' : ''}
                    </div>
                </div>
            `).join('');

            updateNextNodeDropdown();
        }

        function updateNextNodeDropdown() {
            const select = document.getElementById('nodeNext');
            const currentId = currentNodeIndex >= 0 ? project.nodes[currentNodeIndex].id : '';
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">— End / Has Choices —</option>' +
                project.nodes
                    .filter(n => n.id !== currentId)
                    .map(n => `<option value="${n.id}">${n.id}</option>`)
                    .join('');
            
            select.value = currentValue;
        }

        function selectNode(index) {
            currentNodeIndex = index;
            const node = project.nodes[index];

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('nodeEditor').style.display = 'block';

            document.getElementById('nodeId').value = node.id || '';
            document.getElementById('nodeSpeaker').value = node.speaker || '';
            document.getElementById('nodeText').value = node.text || '';
            
            updateNextNodeDropdown();
            document.getElementById('nodeNext').value = node.next || '';

            renderChoices();
            renderNodeList();
        }

        function addNode() {
            const newId = 'node_' + Date.now().toString(36);
            project.nodes.push({
                id: newId,
                speaker: '',
                text: '',
                choices: []
            });

            if (project.nodes.length === 1) {
                project.startNode = newId;
            }

            selectNode(project.nodes.length - 1);
            updateJSONPreview();
        }

        function deleteCurrentNode() {
            if (currentNodeIndex < 0) return;
            
            const nodeId = project.nodes[currentNodeIndex].id;
            project.nodes.splice(currentNodeIndex, 1);

            // Update start node if deleted
            if (project.startNode === nodeId && project.nodes.length > 0) {
                project.startNode = project.nodes[0].id;
            }

            // Clear references to deleted node
            project.nodes.forEach(node => {
                if (node.next === nodeId) node.next = '';
                if (node.choices) {
                    node.choices.forEach(choice => {
                        if (choice.next === nodeId) choice.next = '';
                    });
                }
            });

            currentNodeIndex = -1;
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('nodeEditor').style.display = 'none';
            
            renderNodeList();
            updateJSONPreview();
            showToast('Node deleted');
        }

        function setAsStart() {
            if (currentNodeIndex < 0) return;
            project.startNode = project.nodes[currentNodeIndex].id;
            renderNodeList();
            updateJSONPreview();
            showToast('Start node updated');
        }

        function saveCurrentNode() {
            if (currentNodeIndex < 0) return;

            const node = project.nodes[currentNodeIndex];
            const oldId = node.id;
            const newId = document.getElementById('nodeId').value;

            // Update references if ID changed
            if (oldId !== newId && newId) {
                if (project.startNode === oldId) {
                    project.startNode = newId;
                }
                project.nodes.forEach(n => {
                    if (n.next === oldId) n.next = newId;
                    if (n.choices) {
                        n.choices.forEach(choice => {
                            if (choice.next === oldId) choice.next = newId;
                        });
                    }
                });
            }

            node.id = newId;
            node.speaker = document.getElementById('nodeSpeaker').value;
            node.text = document.getElementById('nodeText').value;
            node.next = document.getElementById('nodeNext').value || undefined;

            // Remove next if has choices
            if (node.choices && node.choices.length > 0) {
                delete node.next;
            }

            renderNodeList();
            updateJSONPreview();
        }

        // Choices
        function renderChoices() {
            if (currentNodeIndex < 0) return;
            
            const node = project.nodes[currentNodeIndex];
            const container = document.getElementById('choicesList');

            if (!node.choices || node.choices.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem; height: auto;"><p style="color: var(--text-muted);">No choices. Add choices or set a "Next Node" for linear dialogue.</p></div>';
                return;
            }

            container.innerHTML = node.choices.map((choice, index) => `
                <div class="choice-card">
                    <div class="choice-header">
                        <span class="choice-number">Choice ${index + 1}</span>
                        <div class="choice-actions">
                            <button class="btn btn-icon" onclick="moveChoice(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn btn-icon" onclick="moveChoice(${index}, 1)" ${index === node.choices.length - 1 ? 'disabled' : ''}>↓</button>
                            <button class="btn btn-icon btn-danger" onclick="deleteChoice(${index})">×</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Choice Text</label>
                        <input type="text" class="form-input" value="${escapeHtml(choice.text || '')}" 
                               onchange="updateChoice(${index}, 'text', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Goes To Node</label>
                        <select class="form-select" onchange="updateChoice(${index}, 'next', this.value)">
                            <option value="">— Select Node —</option>
                            ${project.nodes.filter(n => n.id !== node.id).map(n => 
                                `<option value="${n.id}" ${choice.next === n.id ? 'selected' : ''}>${n.id}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="effects-grid">
                        <div class="effect-group">
                            <div class="effect-title">Approval Effects</div>
                            ${renderApprovalEffects(choice, index)}
                            <button class="btn btn-add-effect" onclick="addApprovalEffect(${index})">+ Effect</button>
                        </div>
                        <div class="effect-group">
                            <div class="effect-title">Stat Effects</div>
                            ${renderStatEffects(choice, index)}
                            <button class="btn btn-add-effect" onclick="addStatEffect(${index})">+ Effect</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderApprovalEffects(choice, choiceIndex) {
            if (!choice.effects || !choice.effects.approvals) return '';
            
            return Object.entries(choice.effects.approvals).map(([key, value], effIndex) => `
                <div class="effect-row">
                    <input type="text" value="${key}" placeholder="approval_id"
                           onchange="updateApprovalEffect(${choiceIndex}, '${key}', this.value, ${value})">
                    <input type="number" value="${value}" 
                           onchange="updateApprovalEffectValue(${choiceIndex}, '${key}', parseInt(this.value))">
                    <button class="btn btn-icon btn-danger" onclick="removeApprovalEffect(${choiceIndex}, '${key}')">×</button>
                </div>
            `).join('');
        }

        function renderStatEffects(choice, choiceIndex) {
            if (!choice.effects || !choice.effects.stats) return '';
            
            return Object.entries(choice.effects.stats).map(([key, value]) => `
                <div class="effect-row">
                    <input type="text" value="${key}" placeholder="stat_name"
                           onchange="updateStatEffect(${choiceIndex}, '${key}', this.value, ${typeof value === 'number' ? value : `'${value}'`})">
                    <input type="${typeof value === 'number' ? 'number' : 'text'}" value="${value}"
                           onchange="updateStatEffectValue(${choiceIndex}, '${key}', this.value)">
                    <button class="btn btn-icon btn-danger" onclick="removeStatEffect(${choiceIndex}, '${key}')">×</button>
                </div>
            `).join('');
        }

        function addChoice() {
            if (currentNodeIndex < 0) return;
            
            const node = project.nodes[currentNodeIndex];
            if (!node.choices) node.choices = [];
            
            node.choices.push({
                text: '',
                next: '',
                effects: {
                    approvals: {},
                    stats: {}
                }
            });

            // Remove next if adding first choice
            if (node.choices.length === 1) {
                delete node.next;
                document.getElementById('nodeNext').value = '';
            }

            renderChoices();
            updateJSONPreview();
        }

        function deleteChoice(index) {
            if (currentNodeIndex < 0) return;
            
            project.nodes[currentNodeIndex].choices.splice(index, 1);
            renderChoices();
            updateJSONPreview();
        }

        function moveChoice(index, direction) {
            if (currentNodeIndex < 0) return;
            
            const choices = project.nodes[currentNodeIndex].choices;
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= choices.length) return;
            
            [choices[index], choices[newIndex]] = [choices[newIndex], choices[index]];
            renderChoices();
            updateJSONPreview();
        }

        function updateChoice(index, field, value) {
            if (currentNodeIndex < 0) return;
            
            project.nodes[currentNodeIndex].choices[index][field] = value;
            updateJSONPreview();
        }

        // Effects
        function addApprovalEffect(choiceIndex) {
            if (currentNodeIndex < 0) return;
            
            const choice = project.nodes[currentNodeIndex].choices[choiceIndex];
            if (!choice.effects) choice.effects = {};
            if (!choice.effects.approvals) choice.effects.approvals = {};
            
            const newKey = 'approval_' + Object.keys(choice.effects.approvals).length;
            choice.effects.approvals[newKey] = 0;
            
            renderChoices();
            updateJSONPreview();
        }

        function updateApprovalEffect(choiceIndex, oldKey, newKey, value) {
            if (currentNodeIndex < 0) return;
            
            const approvals = project.nodes[currentNodeIndex].choices[choiceIndex].effects.approvals;
            delete approvals[oldKey];
            approvals[newKey] = value;
            
            renderChoices();
            updateJSONPreview();
        }

        function updateApprovalEffectValue(choiceIndex, key, value) {
            if (currentNodeIndex < 0) return;
            
            project.nodes[currentNodeIndex].choices[choiceIndex].effects.approvals[key] = value;
            updateJSONPreview();
        }

        function removeApprovalEffect(choiceIndex, key) {
            if (currentNodeIndex < 0) return;
            
            delete project.nodes[currentNodeIndex].choices[choiceIndex].effects.approvals[key];
            renderChoices();
            updateJSONPreview();
        }

        function addStatEffect(choiceIndex) {
            if (currentNodeIndex < 0) return;
            
            const choice = project.nodes[currentNodeIndex].choices[choiceIndex];
            if (!choice.effects) choice.effects = {};
            if (!choice.effects.stats) choice.effects.stats = {};
            
            const newKey = 'stat_' + Object.keys(choice.effects.stats).length;
            choice.effects.stats[newKey] = 1;
            
            renderChoices();
            updateJSONPreview();
        }

        function updateStatEffect(choiceIndex, oldKey, newKey, value) {
            if (currentNodeIndex < 0) return;
            
            const stats = project.nodes[currentNodeIndex].choices[choiceIndex].effects.stats;
            delete stats[oldKey];
            stats[newKey] = value;
            
            renderChoices();
            updateJSONPreview();
        }

        function updateStatEffectValue(choiceIndex, key, value) {
            if (currentNodeIndex < 0) return;
            
            // Try to parse as number
            const numValue = parseFloat(value);
            project.nodes[currentNodeIndex].choices[choiceIndex].effects.stats[key] = 
                isNaN(numValue) ? value : numValue;
            updateJSONPreview();
        }

        function removeStatEffect(choiceIndex, key) {
            if (currentNodeIndex < 0) return;
            
            delete project.nodes[currentNodeIndex].choices[choiceIndex].effects.stats[key];
            renderChoices();
            updateJSONPreview();
        }

        // Approval Types
        function renderApprovalTypes() {
            const container = document.getElementById('approvalTypesList');
            container.innerHTML = project.approvalTypes.map((type, index) => `
                <div class="approval-type-item">
                    <input type="text" value="${type.id}" placeholder="id"
                           onchange="updateApprovalType(${index}, 'id', this.value)">
                    <input type="text" value="${type.name}" placeholder="Display Name"
                           onchange="updateApprovalType(${index}, 'name', this.value)">
                    <input type="number" value="${type.initial}" min="0" max="100"
                           onchange="updateApprovalType(${index}, 'initial', parseInt(this.value))">
                    <button class="btn btn-icon btn-danger" onclick="removeApprovalType(${index})">×</button>
                </div>
            `).join('');
        }

        function addApprovalType() {
            project.approvalTypes.push({
                id: 'approval_' + project.approvalTypes.length,
                name: 'New Approval',
                initial: 50
            });
            renderApprovalTypes();
            updateJSONPreview();
        }

        function updateApprovalType(index, field, value) {
            project.approvalTypes[index][field] = value;
            updateJSONPreview();
        }

        function removeApprovalType(index) {
            project.approvalTypes.splice(index, 1);
            renderApprovalTypes();
            updateJSONPreview();
        }

        // JSON Operations
        function updateJSONPreview() {
            const output = buildOutput();
            document.getElementById('jsonPreview').textContent = JSON.stringify(output, null, 2);
        }

        function buildOutput() {
            // Clean up nodes for export
            const cleanNodes = project.nodes.map(node => {
                const clean = {
                    id: node.id,
                    speaker: node.speaker || undefined,
                    text: node.text
                };

                if (node.choices && node.choices.length > 0) {
                    clean.choices = node.choices.map(choice => {
                        const cleanChoice = {
                            text: choice.text,
                            next: choice.next || undefined
                        };

                        if (choice.effects) {
                            const hasApprovals = choice.effects.approvals && 
                                Object.keys(choice.effects.approvals).length > 0;
                            const hasStats = choice.effects.stats && 
                                Object.keys(choice.effects.stats).length > 0;

                            if (hasApprovals || hasStats) {
                                cleanChoice.effects = {};
                                if (hasApprovals) cleanChoice.effects.approvals = choice.effects.approvals;
                                if (hasStats) cleanChoice.effects.stats = choice.effects.stats;
                            }
                        }

                        return cleanChoice;
                    });
                } else if (node.next) {
                    clean.next = node.next;
                }

                return clean;
            });

            return {
                title: project.title,
                startNode: project.startNode,
                approvalTypes: project.approvalTypes,
                nodes: cleanNodes
            };
        }

        function exportJSON() {
            const output = buildOutput();
            const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (project.title || 'dialogue').toLowerCase().replace(/\s+/g, '_') + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('JSON exported');
        }

        function copyToClipboard() {
            const output = buildOutput();
            navigator.clipboard.writeText(JSON.stringify(output, null, 2))
                .then(() => showToast('Copied to clipboard'))
                .catch(() => showToast('Failed to copy'));
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function importJSON() {
            try {
                const data = JSON.parse(document.getElementById('importTextarea').value);
                
                if (!data.nodes || !Array.isArray(data.nodes)) {
                    throw new Error('Invalid format: missing nodes array');
                }

                project.title = data.title || 'Imported Dialogue';
                project.startNode = data.startNode || (data.nodes[0] ? data.nodes[0].id : '');
                project.approvalTypes = data.approvalTypes || [];
                project.nodes = data.nodes.map(node => ({
                    ...node,
                    choices: node.choices ? node.choices.map(choice => ({
                        ...choice,
                        effects: choice.effects || { approvals: {}, stats: {} }
                    })) : []
                }));

                document.getElementById('projectTitle').value = project.title;
                currentNodeIndex = -1;
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('nodeEditor').style.display = 'none';

                renderNodeList();
                renderApprovalTypes();
                updateJSONPreview();
                closeImportModal();
                showToast('Dialogue imported');

            } catch (e) {
                alert('Error importing: ' + e.message);
            }
        }

        function newProject() {
            if (!confirm('Create new project? Unsaved changes will be lost.')) return;
            
            project = {
                title: 'New Dialogue',
                startNode: '',
                approvalTypes: [
                    { id: 'political', name: 'Political Approval', initial: 50 },
                    { id: 'community', name: 'Community Approval', initial: 50 }
                ],
                nodes: []
            };

            document.getElementById('projectTitle').value = project.title;
            currentNodeIndex = -1;
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('nodeEditor').style.display = 'none';

            renderNodeList();
            renderApprovalTypes();
            updateJSONPreview();
            showToast('New project created');
        }

        // Utilities
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Close modal on overlay click
        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeImportModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    exportJSON();
                } else if (e.key === 'n') {
                    e.preventDefault();
                    addNode();
                }
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
