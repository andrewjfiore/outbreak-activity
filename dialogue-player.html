<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a25;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9590;
            --text-muted: #5a5550;
            --accent-gold: #c9a227;
            --accent-copper: #b87333;
            --accent-teal: #2d8a8a;
            --danger: #8b3a3a;
            --success: #3a6b3a;
            --border: rgba(201, 162, 39, 0.15);
            --question-color: #5b7fc9;
            --decision-color: #c95b7f;
            --selected-color: #4a9;
            --font-scale: 1;
        }

        body.light-mode {
            --bg-deep: #f5f3ef;
            --bg-surface: #ffffff;
            --bg-elevated: #eae8e4;
            --text-primary: #1a1a1f;
            --text-secondary: #5a5a5f;
            --text-muted: #8a8a8f;
            --accent-gold: #a08020;
            --accent-copper: #906030;
            --accent-teal: #207070;
            --danger: #a03030;
            --success: #308030;
            --border: rgba(100, 80, 20, 0.2);
        }

        body.font-small { --font-scale: 0.9; }
        body.font-medium { --font-scale: 1; }
        body.font-large { --font-scale: 1.15; }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(201, 162, 39, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(45, 138, 138, 0.03) 0%, transparent 50%);
            transition: background 0.3s ease, color 0.3s ease;
            font-size: calc(16px * var(--font-scale));
        }

        body.light-mode {
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(201, 162, 39, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(45, 138, 138, 0.08) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            min-height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .title {
            font-size: calc(1.5rem * var(--font-scale));
            font-weight: 600;
            color: var(--accent-gold);
            letter-spacing: 0.05em;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(0.75rem * var(--font-scale));
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--accent-gold);
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--bg-deep);
            border-color: var(--accent-gold);
        }

        .btn-primary:hover {
            background: var(--accent-copper);
            border-color: var(--accent-copper);
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            border-radius: 4px;
        }

        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
        }

        .file-upload-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .font-size-toggle {
            display: flex;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .font-size-btn {
            font-family: 'Crimson Pro', Georgia, serif;
            font-weight: 600;
            padding: 0.4rem 0.6rem;
            background: var(--bg-surface);
            border: none;
            border-right: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .font-size-btn:last-child { border-right: none; }
        .font-size-btn:hover { background: var(--bg-elevated); color: var(--text-secondary); }
        .font-size-btn.active { background: var(--accent-gold); color: var(--bg-deep); }
        .font-size-btn.small { font-size: 0.8rem; }
        .font-size-btn.medium { font-size: 1rem; }
        .font-size-btn.large { font-size: 1.2rem; }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .dialogue-container {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 2rem;
            min-height: 280px;
            max-height: 280px;
            overflow-y: auto;
            position: relative;
        }

        .dialogue-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-teal));
        }

        .dialogue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .speaker-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(0.8rem * var(--font-scale));
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .card-type-buttons { display: flex; gap: 0.5rem; }

        .card-type-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-type-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .card-type-btn.question.active { border-color: var(--question-color); background: var(--question-color); color: white; }
        .card-type-btn.decision.active { border-color: var(--decision-color); background: var(--decision-color); color: white; }

        .dialogue-text {
            font-size: calc(1.15rem * var(--font-scale));
            line-height: 1.8;
            color: var(--text-primary);
            animation: fadeIn 0.4s ease;
            white-space: pre-wrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            min-height: 200px;
        }

        .choice-btn {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: calc(1rem * var(--font-scale));
            padding: 0.9rem 1.1rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-gold);
            transform: scaleY(0);
            transition: transform 0.25s ease;
        }

        .choice-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-gold);
            padding-left: 1.5rem;
        }

        .choice-btn:hover::before { transform: scaleY(1); }
        .choice-btn.question-card::before { background: var(--question-color); }
        .choice-btn.decision-card::before { background: var(--decision-color); }
        .choice-btn.both-card::before { background: linear-gradient(180deg, var(--question-color) 50%, var(--decision-color) 50%); }
        .choice-btn.question-card:hover { border-color: var(--question-color); }
        .choice-btn.decision-card:hover { border-color: var(--decision-color); }

        .card-markers { display: flex; gap: 0.25rem; }

        .card-marker {
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(0.8rem * var(--font-scale));
            font-weight: bold;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .card-marker.question { background: var(--question-color); color: white; }
        .card-marker.decision { background: var(--decision-color); color: white; }

        .choice-text { flex: 1; white-space: pre-wrap; }

        .history-nav {
            display: flex;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .history-nav .btn { flex: 1; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .sidebar { display: flex; flex-direction: column; gap: 1.25rem; }

        .stats-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 1.25rem;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(0.7rem * var(--font-scale));
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px dashed var(--border);
        }

        .stat-item:last-child { border-bottom: none; }
        .stat-label { font-size: calc(0.85rem * var(--font-scale)); color: var(--text-secondary); }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: calc(0.8rem * var(--font-scale)); color: var(--text-primary); }

        .card-counts { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .card-count { display: flex; align-items: center; gap: 0.4rem; font-size: calc(0.8rem * var(--font-scale)); }

        .card-count-marker {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .card-count-marker.question { background: var(--question-color); }
        .card-count-marker.decision { background: var(--decision-color); }

        .history-panel { max-height: 280px; overflow-y: auto; }

        .history-item {
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            background: var(--bg-elevated);
            border-left: 2px solid var(--border);
            font-size: calc(0.8rem * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .history-item:hover { border-left-color: var(--accent-gold); }
        .history-item.current { border-left-color: var(--accent-teal); background: rgba(45, 138, 138, 0.1); }

        .history-markers { display: flex; flex-direction: column; gap: 2px; flex-shrink: 0; margin-top: 2px; }

        .history-marker {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            font-weight: bold;
            color: white;
        }

        .history-marker.question { background: var(--question-color); }
        .history-marker.decision { background: var(--decision-color); }
        .history-marker.normal { background: var(--text-muted); }

        .history-content { flex: 1; min-width: 0; }
        .history-speaker { font-family: 'JetBrains Mono', monospace; font-size: calc(0.6rem * var(--font-scale)); color: var(--accent-gold); text-transform: uppercase; }
        .history-text { color: var(--text-secondary); margin-top: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title { font-size: calc(1.25rem * var(--font-scale)); color: var(--accent-gold); margin-bottom: 1.5rem; }
        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; justify-content: flex-end; }

        .reveal-modal { max-width: 500px; text-align: center; }
        .reveal-title { font-size: calc(1.5rem * var(--font-scale)); color: var(--accent-gold); margin-bottom: 0.5rem; }
        .reveal-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .reveal-stats { text-align: left; }
        .reveal-section { margin-bottom: 1.5rem; }

        .reveal-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: calc(0.75rem * var(--font-scale));
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .reveal-approval { margin-bottom: 1rem; }
        .reveal-approval-header { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
        .reveal-approval-name { font-size: calc(0.95rem * var(--font-scale)); color: var(--text-primary); }
        .reveal-approval-value { font-family: 'JetBrains Mono', monospace; font-size: calc(0.9rem * var(--font-scale)); color: var(--accent-gold); }

        .reveal-bar { height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden; }
        .reveal-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; width: 0; }
        .reveal-bar-fill.high { background: linear-gradient(90deg, var(--accent-teal), #4ab4b4); }
        .reveal-bar-fill.medium { background: linear-gradient(90deg, var(--accent-gold), var(--accent-copper)); }
        .reveal-bar-fill.low { background: linear-gradient(90deg, var(--danger), #a84848); }

        .reveal-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border);
            opacity: 0;
            transform: translateX(-20px);
            animation: revealStat 0.4s ease forwards;
        }

        @keyframes revealStat { to { opacity: 1; transform: translateX(0); } }

        .reveal-stat-label { color: var(--text-secondary); }
        .reveal-stat-value { font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }

        /* Report Modal */
        .report-modal {
            max-width: 700px;
            max-height: 85vh;
        }

        .report-content {
            max-height: 60vh;
            overflow-y: auto;
        }

        .report-section {
            margin-bottom: 1.5rem;
        }

        .report-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .report-stat-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .report-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .report-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .report-path-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--border);
        }

        .report-path-item.has-choice {
            border-left-color: var(--selected-color);
        }

        .report-path-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            min-width: 24px;
        }

        .report-path-content {
            flex: 1;
        }

        .report-path-speaker {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .report-path-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .report-path-choice {
            font-size: 0.8rem;
            color: var(--selected-color);
            padding: 0.4rem 0.6rem;
            background: rgba(68, 170, 153, 0.1);
            border-radius: 4px;
            display: inline-block;
        }

        .report-path-effects {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-copper);
            margin-top: 0.35rem;
        }

        .report-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .report-score-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .report-score-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .report-score-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--accent-teal);
            font-weight: 600;
        }

        /* Decision Tree Modal */
        .tree-modal {
            max-width: 95vw;
            width: 1200px;
            max-height: 90vh;
            padding: 1.5rem;
        }

        .tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tree-legend {
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 0.4rem; color: var(--text-secondary); }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
        .legend-color.selected { background: var(--selected-color); }
        .legend-color.unselected { background: var(--text-muted); opacity: 0.5; }
        .legend-color.question { background: var(--question-color); }
        .legend-color.decision { background: var(--decision-color); }

        /* Tree container with pan and zoom */
        .tree-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 65vh;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }

        .tree-container:active { cursor: grabbing; }

        .tree-viewport {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            padding: 3rem;
            min-width: 100%;
            min-height: 100%;
        }

        .tree-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .tree-controls .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
        }

        /* Tree canvas using SVG for lines */
        .tree-canvas {
            position: relative;
        }

        .tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }

        .tree-line {
            stroke: var(--border);
            stroke-width: 2;
            fill: none;
        }

        .tree-line.selected {
            stroke: var(--selected-color);
            stroke-width: 3;
        }

        /* Tree nodes positioned absolutely */
        .tree-nodes {
            position: relative;
        }

        .tree-node {
            position: absolute;
            background: var(--bg-surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            width: 220px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tree-node:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 4px 20px rgba(201, 162, 39, 0.25);
            transform: translateY(-2px);
            z-index: 100;
        }

        .tree-node.selected {
            border-color: var(--selected-color);
            background: linear-gradient(135deg, rgba(68, 170, 153, 0.15), rgba(68, 170, 153, 0.05));
            box-shadow: 0 0 20px rgba(68, 170, 153, 0.3);
        }

        .tree-node.question-type { border-left: 4px solid var(--question-color); }
        .tree-node.decision-type { border-left: 4px solid var(--decision-color); }
        .tree-node.both-type { border-left: 4px solid var(--accent-gold); }

        .tree-node-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .tree-node-speaker {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .tree-node-markers { display: flex; gap: 0.2rem; }

        .tree-node-marker {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            font-weight: bold;
            padding: 0.1rem 0.25rem;
            border-radius: 3px;
            color: white;
        }

        .tree-node-marker.question { background: var(--question-color); }
        .tree-node-marker.decision { background: var(--decision-color); }

        .tree-node-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tree-node.selected .tree-node-text { color: var(--text-primary); }

        .tree-node-score {
            margin-top: 0.5rem;
            padding-top: 0.4rem;
            border-top: 1px dashed var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--selected-color);
        }

        /* Tooltip */
        .tree-tooltip {
            position: fixed;
            z-index: 2000;
            background: var(--bg-surface);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tree-tooltip.visible { opacity: 1; }

        .tree-tooltip-speaker {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .tree-tooltip-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            margin-bottom: 0.75rem;
        }

        .tree-tooltip-choices { border-top: 1px solid var(--border); padding-top: 0.75rem; }

        .tree-tooltip-choice {
            padding: 0.5rem 0.6rem;
            margin-bottom: 0.4rem;
            background: var(--bg-elevated);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-left: 3px solid var(--border);
        }

        .tree-tooltip-choice.selected {
            border-left-color: var(--selected-color);
            background: rgba(68, 170, 153, 0.15);
            color: var(--text-primary);
        }

        .tree-tooltip-choice-header { display: flex; align-items: center; gap: 0.4rem; }

        .tree-tooltip-choice-marker {
            font-size: 0.6rem;
            font-weight: bold;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            color: white;
        }

        .tree-tooltip-choice-marker.question { background: var(--question-color); }
        .tree-tooltip-choice-marker.decision { background: var(--decision-color); }

        .tree-tooltip-choice-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--selected-color);
            margin-top: 0.25rem;
        }

        .end-summary {
            background: linear-gradient(135deg, var(--bg-surface), var(--bg-elevated));
            border: 1px solid var(--accent-gold);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .end-summary h3 { color: var(--accent-gold); margin-bottom: 0.75rem; }
        .end-summary p { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .end-actions { display: flex; gap: 0.75rem; justify-content: center; margin-top: 1rem; }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { order: -1; flex-direction: row; flex-wrap: wrap; }
            .stats-panel { flex: 1; min-width: 200px; }
        }
    </style>
</head>
<body class="font-medium">
    <div class="container">
        <header class="header">
            <h1 class="title">Dialogue Player</h1>
            <div class="header-actions">
                <div class="file-upload-wrapper">
                    <button class="btn">Upload JSON</button>
                    <input type="file" class="file-upload-input" id="fileUpload" accept=".json">
                </div>
                <button class="btn" onclick="resetGame()">Reset</button>
                <div class="font-size-toggle">
                    <button class="font-size-btn small" onclick="setFontSize('small')" title="Small text">A</button>
                    <button class="font-size-btn medium active" onclick="setFontSize('medium')" title="Medium text">A</button>
                    <button class="font-size-btn large" onclick="setFontSize('large')" title="Large text">A</button>
                </div>
                <button class="btn icon-btn" id="themeToggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
            </div>
        </header>

        <main class="main-content">
            <div class="dialogue-container" id="dialogueContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">‚óá</div>
                    <p>No dialogue loaded. Upload a JSON file to begin.</p>
                </div>
                <div id="dialogueContent" style="display: none;">
                    <div class="dialogue-header">
                        <div class="speaker-name" id="speakerName"></div>
                        <div class="card-type-buttons">
                            <button class="card-type-btn question" id="btnQuestion" onclick="toggleCardType('question')" title="Mark as Question">?</button>
                            <button class="card-type-btn decision" id="btnDecision" onclick="toggleCardType('decision')" title="Mark as Decision">!</button>
                        </div>
                    </div>
                    <div class="dialogue-text" id="dialogueText"></div>
                </div>
            </div>

            <div class="choices-container" id="choicesContainer"></div>

            <div class="history-nav">
                <button class="btn" id="backBtn" onclick="goBack()" disabled>‚Üê Back</button>
                <button class="btn" id="forwardBtn" onclick="goForward()" disabled>Forward ‚Üí</button>
            </div>

            <div id="endSummary" style="display: none;"></div>
        </main>

        <aside class="sidebar">
            <div class="stats-panel">
                <div class="panel-title">Progress</div>
                <div class="stat-item">
                    <span class="stat-label">Time Elapsed</span>
                    <span class="stat-value" id="timeElapsed">0:00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Decisions Made</span>
                    <span class="stat-value" id="decisionCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current Node</span>
                    <span class="stat-value" id="currentNode">‚Äî</span>
                </div>
                <div class="card-counts">
                    <div class="card-count">
                        <span class="card-count-marker question">?</span>
                        <span id="questionCount">0</span>
                    </div>
                    <div class="card-count">
                        <span class="card-count-marker decision">!</span>
                        <span id="decisionTypeCount">0</span>
                    </div>
                </div>
            </div>

            <div class="stats-panel history-panel">
                <div class="panel-title">History</div>
                <div id="historyList"></div>
            </div>
        </aside>
    </div>

    <!-- Reveal Modal -->
    <div class="modal-overlay" id="revealModal">
        <div class="modal reveal-modal">
            <h2 class="reveal-title">üé≠ Journey Complete</h2>
            <p class="reveal-subtitle" id="revealSubtitle"></p>
            <div class="reveal-stats" id="revealStats"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeRevealModal()">Continue</button>
                <button class="btn btn-primary" onclick="openTreeModal()">View Decision Tree</button>
            </div>
        </div>
    </div>

    <!-- Decision Tree Modal -->
    <div class="modal-overlay" id="treeModal">
        <div class="modal tree-modal">
            <div class="tree-header">
                <h2 class="modal-title" style="margin-bottom:0">Your Journey</h2>
                <div class="tree-legend">
                    <div class="legend-item"><span class="legend-color selected"></span> Your Path</div>
                    <div class="legend-item"><span class="legend-color unselected"></span> Other Paths</div>
                    <div class="legend-item"><span class="legend-color question"></span> Question (?)</div>
                    <div class="legend-item"><span class="legend-color decision"></span> Decision (!)</div>
                </div>
            </div>
            <div class="tree-container" id="treeContainer">
                <div class="tree-viewport" id="treeViewport">
                    <div class="tree-canvas" id="treeCanvas">
                        <svg class="tree-svg" id="treeSvg"></svg>
                        <div class="tree-nodes" id="treeNodes"></div>
                    </div>
                </div>
                <div class="tree-controls">
                    <button class="btn" onclick="zoomTree(1.2)">+</button>
                    <button class="btn" onclick="zoomTree(0.8)">‚àí</button>
                    <button class="btn" onclick="resetTreeView()">Reset</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeTreeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal report-modal">
            <h2 class="modal-title">üìã Journey Report</h2>
            <div class="report-content" id="reportContent"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeReportModal()">Close</button>
                <button class="btn btn-primary" onclick="openTreeModal(); closeReportModal();">View Decision Tree</button>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tree-tooltip" id="treeTooltip">
        <div class="tree-tooltip-speaker" id="tooltipSpeaker"></div>
        <div class="tree-tooltip-text" id="tooltipText"></div>
        <div class="tree-tooltip-choices" id="tooltipChoices"></div>
    </div>

    <script>
        // Font size
        function setFontSize(size) {
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add('font-' + size);
            document.querySelectorAll('.font-size-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.font-size-btn.' + size).classList.add('active');
            localStorage.setItem('fontSize', size);
        }
        setFontSize(localStorage.getItem('fontSize') || 'medium');

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-mode');
            document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
        }

        // Game State
        let gameState = {
            dialogueData: null, currentNodeId: null, history: [], historyIndex: -1,
            stats: {}, approvals: {}, startTime: null, decisionCount: 0,
            questionCount: 0, decisionTypeCount: 0, gameEnded: false, pathTaken: [], nodeCardTypes: {}
        };

        let timerInterval = null;

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            gameState.startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
                document.getElementById('timeElapsed').textContent = `${Math.floor(elapsed / 60)}:${(elapsed % 60).toString().padStart(2, '0')}`;
            }, 1000);
        }

        function initializeApprovals() {
            if (!gameState.dialogueData?.approvalTypes) return;
            gameState.approvals = {};
            gameState.dialogueData.approvalTypes.forEach(t => gameState.approvals[t.id] = t.initial || 0);
        }

        function toggleCardType(type) {
            if (!gameState.currentNodeId) return;
            if (!gameState.nodeCardTypes[gameState.currentNodeId]) gameState.nodeCardTypes[gameState.currentNodeId] = { question: false, decision: false };
            gameState.nodeCardTypes[gameState.currentNodeId][type] = !gameState.nodeCardTypes[gameState.currentNodeId][type];
            updateCardTypeButtons();
            renderHistoryList();
        }

        function updateCardTypeButtons() {
            const types = gameState.nodeCardTypes[gameState.currentNodeId] || { question: false, decision: false };
            document.getElementById('btnQuestion').classList.toggle('active', types.question);
            document.getElementById('btnDecision').classList.toggle('active', types.decision);
        }

        function evaluateCondition(cond) {
            if (!cond) return true;
            if (cond.and) return cond.and.every(evaluateCondition);
            if (cond.or) return cond.or.some(evaluateCondition);
            if (cond.not) return !evaluateCondition(cond.not);
            const val = cond.stat ? (gameState.stats[cond.stat] || 0) : (gameState.approvals[cond.approval] || 0);
            const op = cond.op || '>=', target = cond.value;
            switch (op) {
                case '==': case '=': return val === target;
                case '!=': return val !== target;
                case '>': return val > target;
                case '>=': return val >= target;
                case '<': return val < target;
                case '<=': return val <= target;
                default: return true;
            }
        }

        function getConditionalNext(node) {
            if (node.conditionalNext) for (const c of node.conditionalNext) if (evaluateCondition(c.condition)) return c.next;
            return node.next || null;
        }

        function filterChoicesByCondition(choices) {
            return (choices || []).filter(c => !c.condition || evaluateCondition(c.condition));
        }

        function displayNode(nodeId, addToHistory = true) {
            const node = gameState.dialogueData.nodes.find(n => n.id === nodeId);
            if (!node) return;

            gameState.currentNodeId = nodeId;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dialogueContent').style.display = 'block';
            document.getElementById('speakerName').textContent = node.speaker || 'Narrator';
            document.getElementById('dialogueText').textContent = (node.text || '').replace(/\\n/g, '\n');
            document.getElementById('currentNode').textContent = nodeId;
            updateCardTypeButtons();

            const choicesEl = document.getElementById('choicesContainer');
            const filtered = filterChoicesByCondition(node.choices);

            if (filtered.length > 0) {
                choicesEl.innerHTML = filtered.map(c => {
                    const types = [];
                    if (c.type === 'question' || c.type === 'both') types.push('question');
                    if (c.type === 'decision' || c.type === 'both') types.push('decision');
                    const cardClass = types.length === 2 ? 'both-card' : types[0] ? types[0] + '-card' : '';
                    const markers = types.length ? '<span class="card-markers">' + types.map(t => `<span class="card-marker ${t}">${t === 'question' ? '?' : '!'}</span>`).join('') + '</span>' : '';
                    const origIdx = node.choices.indexOf(c);
                    return `<button class="choice-btn ${cardClass}" onclick="makeChoice(${origIdx})">${markers}<span class="choice-text">${(c.text || '').replace(/\\n/g, '\n')}</span></button>`;
                }).join('');
            } else {
                const nextNode = getConditionalNext(node);
                if (nextNode) {
                    choicesEl.innerHTML = `<button class="choice-btn" onclick="continueDialogue('${nextNode}')"><span class="choice-text">Continue</span></button>`;
                } else {
                    gameState.gameEnded = true;
                    showStatsReveal();
                    choicesEl.innerHTML = '';
                    document.getElementById('endSummary').style.display = 'block';
                    document.getElementById('endSummary').innerHTML = `<div class="end-summary"><h3>üé≠ End of Journey</h3><p>You made <strong>${gameState.decisionCount}</strong> choices.</p><div class="end-actions"><button class="btn" onclick="openReportModal()">View Report</button><button class="btn btn-primary" onclick="openTreeModal()">View Decision Tree</button></div></div>`;
                }
            }

            if (addToHistory) {
                gameState.history = gameState.history.slice(0, gameState.historyIndex + 1);
                const choiceTypes = gameState.pathTaken.length ? (gameState.pathTaken[gameState.pathTaken.length - 1].types || { question: false, decision: false }) : { question: false, decision: false };
                gameState.history.push({
                    nodeId, stats: JSON.parse(JSON.stringify(gameState.stats)), approvals: JSON.parse(JSON.stringify(gameState.approvals)),
                    decisionCount: gameState.decisionCount, questionCount: gameState.questionCount, decisionTypeCount: gameState.decisionTypeCount, choiceTypes
                });
                gameState.historyIndex = gameState.history.length - 1;
            }
            updateHistoryButtons();
            renderHistoryList();
        }

        function makeChoice(idx) {
            const node = gameState.dialogueData.nodes.find(n => n.id === gameState.currentNodeId);
            const choice = node.choices[idx];
            const types = { question: false, decision: false };

            if (choice.type === 'question' || choice.type === 'both') { types.question = true; gameState.questionCount++; document.getElementById('questionCount').textContent = gameState.questionCount; }
            if (choice.type === 'decision' || choice.type === 'both') { types.decision = true; gameState.decisionTypeCount++; document.getElementById('decisionTypeCount').textContent = gameState.decisionTypeCount; }

            gameState.pathTaken.push({ nodeId: gameState.currentNodeId, choiceIndex: idx, choiceText: choice.text, next: choice.next, types, effects: choice.effects });

            if (choice.effects) {
                if (choice.effects.approvals) Object.entries(choice.effects.approvals).forEach(([k, v]) => gameState.approvals[k] = Math.max(0, (gameState.approvals[k] || 0) + v));
                if (choice.effects.stats) Object.entries(choice.effects.stats).forEach(([k, v]) => gameState.stats[k] = typeof v === 'number' ? (gameState.stats[k] || 0) + v : v);
            }

            gameState.decisionCount++;
            document.getElementById('decisionCount').textContent = gameState.decisionCount;
            if (choice.next) displayNode(choice.next);
        }

        function continueDialogue(nextId) {
            gameState.pathTaken.push({ nodeId: gameState.currentNodeId, choiceIndex: -1, choiceText: '[Continue]', next: nextId, types: { question: false, decision: false } });
            displayNode(nextId);
        }

        function showStatsReveal() {
            document.getElementById('revealSubtitle').textContent = `${gameState.decisionCount} decisions ‚Ä¢ ${document.getElementById('timeElapsed').textContent} elapsed`;
            let html = '';
            if (gameState.dialogueData?.approvalTypes?.length) {
                html += '<div class="reveal-section"><div class="reveal-section-title">Approval Ratings</div>';
                gameState.dialogueData.approvalTypes.forEach((t, i) => {
                    const val = gameState.approvals[t.id] || 0;
                    const maxVal = Math.max(10, ...Object.values(gameState.approvals));
                    const pct = maxVal > 0 ? (val / maxVal) * 100 : 0;
                    html += `<div class="reveal-approval"><div class="reveal-approval-header"><span class="reveal-approval-name">${t.name}</span><span class="reveal-approval-value">${val}</span></div><div class="reveal-bar"><div class="reveal-bar-fill ${val >= 5 ? 'high' : val >= 2 ? 'medium' : 'low'}" data-width="${pct}" style="animation-delay:${i * 0.2}s"></div></div></div>`;
                });
                html += '</div>';
            }
            const statKeys = Object.keys(gameState.stats);
            if (statKeys.length) {
                html += '<div class="reveal-section"><div class="reveal-section-title">Acquired Traits</div>';
                statKeys.forEach((k, i) => {
                    const v = gameState.stats[k];
                    html += `<div class="reveal-stat-item" style="animation-delay:${0.5 + i * 0.15}s"><span class="reveal-stat-label">${k}</span><span class="reveal-stat-value">${typeof v === 'number' ? (v > 0 ? '+' : '') + v : v}</span></div>`;
                });
                html += '</div>';
            }
            html += `<div class="reveal-section"><div class="reveal-section-title">Card Types</div><div class="reveal-stat-item" style="animation-delay:0.8s"><span class="reveal-stat-label"><span class="card-count-marker question" style="display:inline-flex;width:16px;height:16px;font-size:0.7rem;margin-right:6px">?</span> Questions</span><span class="reveal-stat-value">${gameState.questionCount}</span></div><div class="reveal-stat-item" style="animation-delay:0.95s"><span class="reveal-stat-label"><span class="card-count-marker decision" style="display:inline-flex;width:16px;height:16px;font-size:0.7rem;margin-right:6px">!</span> Decisions</span><span class="reveal-stat-value">${gameState.decisionTypeCount}</span></div></div>`;
            document.getElementById('revealStats').innerHTML = html;
            document.getElementById('revealModal').classList.add('active');
            setTimeout(() => document.querySelectorAll('.reveal-bar-fill').forEach(el => el.style.width = el.dataset.width + '%'), 100);
        }

        function closeRevealModal() { document.getElementById('revealModal').classList.remove('active'); }

        function goBack() {
            if (gameState.historyIndex > 0) {
                gameState.historyIndex--;
                const s = gameState.history[gameState.historyIndex];
                Object.assign(gameState, { stats: JSON.parse(JSON.stringify(s.stats)), approvals: JSON.parse(JSON.stringify(s.approvals)), decisionCount: s.decisionCount, questionCount: s.questionCount, decisionTypeCount: s.decisionTypeCount });
                document.getElementById('decisionCount').textContent = s.decisionCount;
                document.getElementById('questionCount').textContent = s.questionCount;
                document.getElementById('decisionTypeCount').textContent = s.decisionTypeCount;
                displayNode(s.nodeId, false);
            }
        }

        function goForward() {
            if (gameState.historyIndex < gameState.history.length - 1) {
                gameState.historyIndex++;
                const s = gameState.history[gameState.historyIndex];
                Object.assign(gameState, { stats: JSON.parse(JSON.stringify(s.stats)), approvals: JSON.parse(JSON.stringify(s.approvals)), decisionCount: s.decisionCount, questionCount: s.questionCount, decisionTypeCount: s.decisionTypeCount });
                displayNode(s.nodeId, false);
            }
        }

        function jumpToHistory(idx) {
            gameState.historyIndex = idx;
            const s = gameState.history[idx];
            Object.assign(gameState, { stats: JSON.parse(JSON.stringify(s.stats)), approvals: JSON.parse(JSON.stringify(s.approvals)), decisionCount: s.decisionCount, questionCount: s.questionCount, decisionTypeCount: s.decisionTypeCount });
            displayNode(s.nodeId, false);
        }

        function updateHistoryButtons() {
            document.getElementById('backBtn').disabled = gameState.historyIndex <= 0;
            document.getElementById('forwardBtn').disabled = gameState.historyIndex >= gameState.history.length - 1;
        }

        function renderHistoryList() {
            document.getElementById('historyList').innerHTML = gameState.history.map((item, i) => {
                const node = gameState.dialogueData.nodes.find(n => n.id === item.nodeId);
                const text = (node.text || '').replace(/\\n/g, ' ');
                const userTypes = gameState.nodeCardTypes[item.nodeId] || {};
                const hasQ = userTypes.question || item.choiceTypes?.question;
                const hasD = userTypes.decision || item.choiceTypes?.decision;
                let markers = '<div class="history-markers">';
                if (hasQ) markers += '<span class="history-marker question">?</span>';
                if (hasD) markers += '<span class="history-marker decision">!</span>';
                if (!hasQ && !hasD) markers += '<span class="history-marker normal">¬∑</span>';
                markers += '</div>';
                return `<div class="history-item ${i === gameState.historyIndex ? 'current' : ''}" onclick="jumpToHistory(${i})">${markers}<div class="history-content"><div class="history-speaker">${node.speaker || 'Narrator'}</div><div class="history-text">${text.substring(0, 40)}${text.length > 40 ? '...' : ''}</div></div></div>`;
            }).join('');
        }

        // Decision Tree with proper positioning and SVG lines
        let treeState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, startX: 0, startY: 0 };

        function renderDecisionTree() {
            const nodesEl = document.getElementById('treeNodes');
            const svgEl = document.getElementById('treeSvg');
            nodesEl.innerHTML = '';
            svgEl.innerHTML = '';

            const takenMap = new Map();
            gameState.pathTaken.forEach(p => takenMap.set(p.nodeId, p));
            const visitedNodes = new Set(gameState.history.map(h => h.nodeId));

            // Calculate positions using a tree layout
            const nodePositions = new Map();
            const nodeWidth = 220;
            const nodeHeight = 100;
            const horizontalGap = 40;
            const verticalGap = 80;

            // Build adjacency and calculate levels
            const levels = new Map();
            const children = new Map();
            const visited = new Set();

            function buildTree(nodeId, level) {
                if (!nodeId || visited.has(nodeId)) return;
                visited.add(nodeId);

                const node = gameState.dialogueData.nodes.find(n => n.id === nodeId);
                if (!node) return;

                if (!levels.has(level)) levels.set(level, []);
                levels.get(level).push(nodeId);

                const childNodes = [];
                if (node.choices?.length) {
                    node.choices.forEach(c => {
                        if (c.next && !visited.has(c.next)) {
                            childNodes.push(c.next);
                            buildTree(c.next, level + 1);
                        }
                    });
                } else if (node.next && !visited.has(node.next)) {
                    childNodes.push(node.next);
                    buildTree(node.next, level + 1);
                }
                if (node.conditionalNext) {
                    node.conditionalNext.forEach(c => {
                        if (c.next && !visited.has(c.next)) {
                            childNodes.push(c.next);
                            buildTree(c.next, level + 1);
                        }
                    });
                }
                children.set(nodeId, childNodes);
            }

            const startNode = gameState.dialogueData.startNode || gameState.dialogueData.nodes[0].id;
            buildTree(startNode, 0);

            // Position nodes
            let maxWidth = 0;
            levels.forEach((nodeIds, level) => {
                const totalWidth = nodeIds.length * nodeWidth + (nodeIds.length - 1) * horizontalGap;
                maxWidth = Math.max(maxWidth, totalWidth);
            });

            levels.forEach((nodeIds, level) => {
                const totalWidth = nodeIds.length * nodeWidth + (nodeIds.length - 1) * horizontalGap;
                const startX = (maxWidth - totalWidth) / 2;
                const y = level * (nodeHeight + verticalGap);

                nodeIds.forEach((nodeId, idx) => {
                    const x = startX + idx * (nodeWidth + horizontalGap);
                    nodePositions.set(nodeId, { x, y });
                });
            });

            // Draw SVG lines
            let svgContent = '';
            nodePositions.forEach((pos, nodeId) => {
                const childList = children.get(nodeId) || [];
                const pathInfo = takenMap.get(nodeId);

                childList.forEach((childId, idx) => {
                    const childPos = nodePositions.get(childId);
                    if (!childPos) return;

                    const node = gameState.dialogueData.nodes.find(n => n.id === nodeId);
                    let isSelected = false;
                    if (pathInfo?.next === childId) isSelected = true;

                    const startX = pos.x + nodeWidth / 2;
                    const startY = pos.y + nodeHeight;
                    const endX = childPos.x + nodeWidth / 2;
                    const endY = childPos.y;
                    const midY = startY + (endY - startY) / 2;

                    svgContent += `<path class="tree-line ${isSelected ? 'selected' : ''}" d="M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}" />`;
                });
            });
            svgEl.innerHTML = svgContent;

            // Render nodes
            let nodesContent = '';
            nodePositions.forEach((pos, nodeId) => {
                const node = gameState.dialogueData.nodes.find(n => n.id === nodeId);
                if (!node) return;

                const isSelected = visitedNodes.has(nodeId);
                const pathInfo = takenMap.get(nodeId);
                const userTypes = gameState.nodeCardTypes[nodeId] || {};
                let hasQ = userTypes.question, hasD = userTypes.decision;

                if (node.choices?.length) {
                    node.choices.forEach(c => {
                        if (c.type === 'question' || c.type === 'both') hasQ = true;
                        if (c.type === 'decision' || c.type === 'both') hasD = true;
                    });
                }

                const typeClass = hasQ && hasD ? 'both-type' : hasQ ? 'question-type' : hasD ? 'decision-type' : '';
                const text = (node.text || '').replace(/\\n/g, ' ');

                let markers = '';
                if (hasQ || hasD) {
                    markers = '<span class="tree-node-markers">';
                    if (hasQ) markers += '<span class="tree-node-marker question">?</span>';
                    if (hasD) markers += '<span class="tree-node-marker decision">!</span>';
                    markers += '</span>';
                }

                let scoreHtml = '';
                if (isSelected && pathInfo?.effects) {
                    const scores = [];
                    if (pathInfo.effects.approvals) {
                        Object.entries(pathInfo.effects.approvals).forEach(([k, v]) => {
                            const name = gameState.dialogueData.approvalTypes?.find(a => a.id === k)?.name || k;
                            scores.push(`${name}: ${v > 0 ? '+' : ''}${v}`);
                        });
                    }
                    if (pathInfo.effects.stats) {
                        Object.entries(pathInfo.effects.stats).forEach(([k, v]) => {
                            scores.push(`${k}: ${typeof v === 'number' ? (v > 0 ? '+' : '') + v : v}`);
                        });
                    }
                    if (scores.length) scoreHtml = `<div class="tree-node-score">${scores.join(' ‚Ä¢ ')}</div>`;
                }

                nodesContent += `
                    <div class="tree-node ${isSelected ? 'selected' : ''} ${typeClass}"
                         style="left: ${pos.x}px; top: ${pos.y}px;"
                         data-node-id="${nodeId}"
                         data-speaker="${escapeAttr(node.speaker || 'Narrator')}"
                         data-text="${escapeAttr((node.text || '').replace(/\\n/g, '\n'))}"
                         data-choices="${escapeAttr(JSON.stringify(node.choices || []))}"
                         data-selected-choice="${pathInfo ? pathInfo.choiceIndex : -1}"
                         onmouseenter="showTreeTooltip(event, this)"
                         onmouseleave="hideTreeTooltip()">
                        <div class="tree-node-header">
                            <span class="tree-node-speaker">${node.speaker || 'Narrator'}</span>
                            ${markers}
                        </div>
                        <div class="tree-node-text">${text.substring(0, 50)}${text.length > 50 ? '...' : ''}</div>
                        ${scoreHtml}
                    </div>
                `;
            });
            nodesEl.innerHTML = nodesContent;

            // Set canvas size
            const canvas = document.getElementById('treeCanvas');
            const maxX = Math.max(...Array.from(nodePositions.values()).map(p => p.x)) + nodeWidth + 100;
            const maxY = Math.max(...Array.from(nodePositions.values()).map(p => p.y)) + nodeHeight + 100;
            canvas.style.width = maxX + 'px';
            canvas.style.height = maxY + 'px';
            svgEl.setAttribute('width', maxX);
            svgEl.setAttribute('height', maxY);
            svgEl.setAttribute('viewBox', `0 0 ${maxX} ${maxY}`);

            resetTreeView();
        }

        function escapeAttr(str) {
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showTreeTooltip(e, el) {
            const tooltip = document.getElementById('treeTooltip');
            document.getElementById('tooltipSpeaker').textContent = el.dataset.speaker;
            document.getElementById('tooltipText').textContent = el.dataset.text;

            const choices = JSON.parse(el.dataset.choices || '[]');
            const selectedIdx = parseInt(el.dataset.selectedChoice);
            const choicesEl = document.getElementById('tooltipChoices');

            if (choices.length) {
                choicesEl.style.display = 'block';
                choicesEl.innerHTML = choices.map((c, i) => {
                    const isSelected = i === selectedIdx;
                    const types = [];
                    if (c.type === 'question' || c.type === 'both') types.push('question');
                    if (c.type === 'decision' || c.type === 'both') types.push('decision');
                    const markers = types.map(t => `<span class="tree-tooltip-choice-marker ${t}">${t === 'question' ? '?' : '!'}</span>`).join('');

                    let scoreHtml = '';
                    if (isSelected && c.effects) {
                        const scores = [];
                        if (c.effects.approvals) Object.entries(c.effects.approvals).forEach(([k, v]) => {
                            const name = gameState.dialogueData.approvalTypes?.find(a => a.id === k)?.name || k;
                            scores.push(`${name}: ${v > 0 ? '+' : ''}${v}`);
                        });
                        if (c.effects.stats) Object.entries(c.effects.stats).forEach(([k, v]) => scores.push(`${k}: ${typeof v === 'number' ? (v > 0 ? '+' : '') + v : v}`));
                        if (scores.length) scoreHtml = `<div class="tree-tooltip-choice-score">‚Üí ${scores.join(' ‚Ä¢ ')}</div>`;
                    }

                    return `<div class="tree-tooltip-choice ${isSelected ? 'selected' : ''}"><div class="tree-tooltip-choice-header">${markers}<span>${(c.text || '').replace(/\\n/g, ' ')}</span></div>${scoreHtml}</div>`;
                }).join('');
            } else {
                choicesEl.style.display = 'none';
            }

            tooltip.classList.add('visible');
            const rect = tooltip.getBoundingClientRect();
            let x = e.clientX + 20, y = e.clientY + 20;
            if (x + rect.width > window.innerWidth - 20) x = e.clientX - rect.width - 20;
            if (y + rect.height > window.innerHeight - 20) y = e.clientY - rect.height - 20;
            tooltip.style.left = Math.max(10, x) + 'px';
            tooltip.style.top = Math.max(10, y) + 'px';
        }

        function hideTreeTooltip() { document.getElementById('treeTooltip').classList.remove('visible'); }

        // Pan and zoom
        function updateTreeTransform() {
            document.getElementById('treeViewport').style.transform = `translate(${treeState.offsetX}px, ${treeState.offsetY}px) scale(${treeState.scale})`;
        }

        function zoomTree(factor) {
            treeState.scale = Math.max(0.2, Math.min(2, treeState.scale * factor));
            updateTreeTransform();
        }

        function resetTreeView() {
            treeState.scale = 1;
            treeState.offsetX = 0;
            treeState.offsetY = 0;
            updateTreeTransform();
        }

        const treeContainer = document.getElementById('treeContainer');

        treeContainer.addEventListener('mousedown', e => {
            if (e.target.closest('.tree-node') || e.target.closest('.tree-controls')) return;
            treeState.isDragging = true;
            treeState.startX = e.clientX - treeState.offsetX;
            treeState.startY = e.clientY - treeState.offsetY;
        });

        document.addEventListener('mousemove', e => {
            if (!treeState.isDragging) return;
            treeState.offsetX = e.clientX - treeState.startX;
            treeState.offsetY = e.clientY - treeState.startY;
            updateTreeTransform();
        });

        document.addEventListener('mouseup', () => treeState.isDragging = false);

        treeContainer.addEventListener('wheel', e => {
            e.preventDefault();
            const factor = e.deltaY > 0 ? 0.9 : 1.1;
            zoomTree(factor);
        }, { passive: false });

        function openTreeModal() {
            document.getElementById('treeModal').classList.add('active');
            closeRevealModal();
            setTimeout(renderDecisionTree, 100);
        }

        function closeTreeModal() { document.getElementById('treeModal').classList.remove('active'); }

        function openReportModal() {
            const content = document.getElementById('reportContent');
            let html = '';

            // Summary stats
            html += '<div class="report-summary">';
            html += `<div class="report-stat-box"><div class="report-stat-value">${gameState.decisionCount}</div><div class="report-stat-label">Decisions</div></div>`;
            html += `<div class="report-stat-box"><div class="report-stat-value">${gameState.questionCount}</div><div class="report-stat-label">Questions (?)</div></div>`;
            html += `<div class="report-stat-box"><div class="report-stat-value">${gameState.decisionTypeCount}</div><div class="report-stat-label">Decisions (!)</div></div>`;
            html += `<div class="report-stat-box"><div class="report-stat-value">${document.getElementById('timeElapsed').textContent}</div><div class="report-stat-label">Time</div></div>`;
            html += '</div>';

            // Final scores
            const hasApprovals = gameState.dialogueData?.approvalTypes?.length > 0;
            const hasStats = Object.keys(gameState.stats).length > 0;

            if (hasApprovals || hasStats) {
                html += '<div class="report-section"><div class="report-section-title">Final Scores</div><div class="report-scores">';
                if (hasApprovals) {
                    gameState.dialogueData.approvalTypes.forEach(t => {
                        const val = gameState.approvals[t.id] || 0;
                        html += `<div class="report-score-item"><span class="report-score-name">${t.name}</span><span class="report-score-value">${val}</span></div>`;
                    });
                }
                if (hasStats) {
                    Object.entries(gameState.stats).forEach(([k, v]) => {
                        const display = typeof v === 'number' ? v : v;
                        html += `<div class="report-score-item"><span class="report-score-name">${k}</span><span class="report-score-value">${display}</span></div>`;
                    });
                }
                html += '</div></div>';
            }

            // Path taken
            html += '<div class="report-section"><div class="report-section-title">Your Path</div>';
            gameState.history.forEach((item, i) => {
                const node = gameState.dialogueData.nodes.find(n => n.id === item.nodeId);
                const pathInfo = gameState.pathTaken.find(p => p.nodeId === item.nodeId);
                const hasChoice = pathInfo && pathInfo.choiceIndex >= 0;

                html += `<div class="report-path-item ${hasChoice ? 'has-choice' : ''}">`;
                html += `<div class="report-path-number">${i + 1}</div>`;
                html += '<div class="report-path-content">';
                html += `<div class="report-path-speaker">${node.speaker || 'Narrator'}</div>`;
                html += `<div class="report-path-text">${(node.text || '').replace(/\\n/g, ' ').substring(0, 100)}${(node.text || '').length > 100 ? '...' : ''}</div>`;

                if (hasChoice) {
                    const choice = node.choices[pathInfo.choiceIndex];
                    html += `<div class="report-path-choice">‚Üí ${(choice.text || '').replace(/\\n/g, ' ')}</div>`;

                    if (pathInfo.effects) {
                        const effects = [];
                        if (pathInfo.effects.approvals) {
                            Object.entries(pathInfo.effects.approvals).forEach(([k, v]) => {
                                const name = gameState.dialogueData.approvalTypes?.find(a => a.id === k)?.name || k;
                                effects.push(`${name}: ${v > 0 ? '+' : ''}${v}`);
                            });
                        }
                        if (pathInfo.effects.stats) {
                            Object.entries(pathInfo.effects.stats).forEach(([k, v]) => {
                                effects.push(`${k}: ${typeof v === 'number' ? (v > 0 ? '+' : '') + v : v}`);
                            });
                        }
                        if (effects.length) {
                            html += `<div class="report-path-effects">${effects.join(' ‚Ä¢ ')}</div>`;
                        }
                    }
                }

                html += '</div></div>';
            });
            html += '</div>';

            content.innerHTML = html;
            document.getElementById('reportModal').classList.add('active');
        }

        function closeReportModal() { document.getElementById('reportModal').classList.remove('active'); }

        // File upload
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try { loadDialogueData(JSON.parse(ev.target.result)); }
                catch (err) { alert('Error parsing JSON: ' + err.message); }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function loadDialogueData(data) {
            if (!data.nodes?.length) throw new Error('Invalid format: missing nodes array');
            gameState = {
                dialogueData: data, currentNodeId: null, history: [], historyIndex: -1,
                stats: {}, approvals: {}, startTime: null, decisionCount: 0,
                questionCount: 0, decisionTypeCount: 0, gameEnded: false, pathTaken: [], nodeCardTypes: {}
            };
            document.getElementById('decisionCount').textContent = '0';
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('decisionTypeCount').textContent = '0';
            document.getElementById('endSummary').style.display = 'none';
            if (data.title) document.querySelector('.title').textContent = data.title;
            initializeApprovals();
            startTimer();
            displayNode(data.startNode || data.nodes[0].id);
        }

        function resetGame() {
            if (!gameState.dialogueData) return;
            gameState = { ...gameState, history: [], historyIndex: -1, stats: {}, decisionCount: 0, questionCount: 0, decisionTypeCount: 0, gameEnded: false, pathTaken: [], nodeCardTypes: {} };
            document.getElementById('decisionCount').textContent = '0';
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('decisionTypeCount').textContent = '0';
            document.getElementById('endSummary').style.display = 'none';
            initializeApprovals();
            startTimer();
            displayNode(gameState.dialogueData.startNode || gameState.dialogueData.nodes[0].id);
        }

        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'TEXTAREA') return;
            const num = parseInt(e.key);
            if (num >= 1 && num <= 9) document.querySelectorAll('.choice-btn')[num - 1]?.click();
            if (e.key === 'ArrowLeft') goBack();
            if (e.key === 'ArrowRight') goForward();
            if (e.key === 'Escape') { closeTreeModal(); closeRevealModal(); }
        });

        document.getElementById('treeModal').addEventListener('click', e => e.target.classList.contains('modal-overlay') && closeTreeModal());
        document.getElementById('revealModal').addEventListener('click', e => e.target.classList.contains('modal-overlay') && closeRevealModal());
        document.getElementById('reportModal').addEventListener('click', e => e.target.classList.contains('modal-overlay') && closeReportModal());
    </script>
</body>
</html>
